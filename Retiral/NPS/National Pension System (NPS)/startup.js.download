(function(window, dojo) {
  'use strict';
  dojo.require('dojo.cookie');
  function startTouchpoint() {
	  localStorage.setItem('userSubmitedUrl', window.location.href);
    document.getElementById('touchpoint-startup-link').click();
  }

  function touchpointDecideStartup(userextId) {
	
	// BOCA-3084: Onboardingwizard is not started when you access a Blog post
	if (userextId == undefined || userextId.length <= 0) {
		userextId = window.currentLogin.extid;
	}
	
    if (userextId) {
		// Patched: Don't read session from localStorage! See EPTACT-1580
        // reg was not received from localStorage nor cookie or does not contain my userId --> have to get it from extensionAttribute
        // Using dojo.xhrGet, as we simply want to retrieve information
        dojo.xhrGet({
          // The URL of the request
          url: '/profiles/atom/profileExtension.do?extensionId=touchpointState&userid=' + userextId,
          // Handle the result as JSON data
          handleAs: 'json',
          preventCache: true,
          // The success handler
          load: function(jsonData) {
            if (jsonData && ((jsonData.state === 'complete')|| (jsonData.state === 'skipped') )) {
              try {
				localStorage.removeItem('touchpoint.state');
				localStorage.removeItem('touchpoint.state.expires');
				localStorage.removeItem('touchpoint.session');
              } catch (e) {
                /*
                try {
                  reg = dojo.fromJson(dojo.cookie('touchpointState')) || {};
                  reg[userextId] = jsonData;
                  dojo.cookie('touchpointState', dojo.toJson(reg), {
                    path: '/',
                    expire: 1
                  });
                } catch (e) {}
                */
              }
            } else {
              startTouchpoint();
            }
          }
        });
      }
  }

  window.touchpointDecideStartup = touchpointDecideStartup;
})(window, dojo);